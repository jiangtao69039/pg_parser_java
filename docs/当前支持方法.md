# pg_parser_java

## 高级 API（推荐使用）

### PgQuery.parse(sql) - 解析为 JSON
解析 SQL 语句，返回 JSON 格式的语法树。

```java
import com.github.ttttz.pgParser.PgQueryWrapper;
import com.github.ttttz.pgParser.PgQueryException;

@Test
public void test_parse_json() throws PgQueryException {
    String json = PgQueryWrapper.parse("SELECT * FROM users WHERE id = 1");

    System.out.println(json);
    // 输出: {"version":170007,"stmts":[{"stmt":{"SelectStmt":{...}}}]}
}
```

----------

### PgQuery.parseTree(sql) - 解析为 Protobuf 对象
解析 SQL 语句，返回强类型的 Protobuf 对象，便于程序化访问语法树。

```java
import com.github.ttttz.pgParser.PgQueryWrapper;
import com.github.ttttz.pgParser.PgQueryException;
import pg_query.PgQuery.ParseResult;
import pg_query.PgQuery.RawStmt;
import pg_query.PgQuery.Node;
import pg_query.PgQuery.SelectStmt;
import pg_query.PgQuery.RangeVar;

@Test
public void test_parse_protobuf() throws PgQueryException {
    ParseResult result = PgQueryWrapper.parseTree("SELECT * FROM users WHERE id = 1");

    // 获取语句数量
    System.out.println("Statements count: " + result.getStmtsCount());

    // 获取第一个语句
    RawStmt rawStmt = result.getStmts(0);
    Node stmtNode = rawStmt.getStmt();

    // 检查是否为 SELECT 语句
    if (stmtNode.hasSelectStmt()) {
        SelectStmt selectStmt = stmtNode.getSelectStmt();

        // 获取 FROM 子句中的表名
        Node fromNode = selectStmt.getFromClause(0);
        if (fromNode.hasRangeVar()) {
            RangeVar rangeVar = fromNode.getRangeVar();
            System.out.println("Table name: " + rangeVar.getRelname());
            // 输出: Table name: users
        }
    }
}
```

----------

### PgQuery.split(sql) - 分割多条 SQL 语句
将多条 SQL 语句分割为列表。

```java
import com.github.ttttz.pgParser.PgQueryWrapper;
import com.github.ttttz.pgParser.PgQueryException;

import java.util.List;

@Test
public void test_split() throws PgQueryException {
    List<String> statements = PgQueryWrapper.split("SELECT 1; SELECT 2; SELECT 3;");

    System.out.println(statements.size());  // 输出: 3
    System.out.println(statements.get(0));  // 输出: SELECT 1
    System.out.println(statements.get(1));  // 输出: SELECT 2
    System.out.println(statements.get(2));  // 输出: SELECT 3
}
```

----------

### 错误处理
当 SQL 语法错误时，会抛出 `PgQueryException` 异常。

```java
@Test
public void test_parse_error() {
    try {
        PgQuery.parse("SELECT * FROM");  // 不完整的 SQL
    } catch (PgQueryException e) {
        System.out.println("Error: " + e.getMessage());
        // 输出: Error: syntax error at end of input at position 14
    }
}
```

----------
----------

## 底层 API

以下是直接调用 libpg_query 的底层 API，需要手动管理内存释放。

### pg_query_parse - 解析为 JSON（底层）

```java
import com.github.ttttz.pgParser.PgQueryLibInterface;
import com.github.ttttz.pgParser.parse.PgQueryParseResult;

@Test
public void test_parse_low_level() {
    String sql = "SELECT * FROM users";
    PgQueryParseResult.ByValue result = PgQueryLibInterface.INSTANCE.pg_query_parse(sql);

    if (!result.hasError()) {
        System.out.println("Parse tree: " + result.parse_tree);
    } else {
        System.out.println("Error: " + result.getErrorMessage());
    }

    // 必须释放内存
    PgQueryLibInterface.INSTANCE.pg_query_free_parse_result(result);
}
```

----------

### pg_query_parse_protobuf - 解析为 Protobuf（底层）

```java
import com.github.ttttz.pgParser.PgQueryLibInterface;
import com.github.ttttz.pgParser.parse.PgQueryProtobufParseResult;
import pg_query.PgQuery.ParseResult;

@Test
public void test_parse_protobuf_low_level() throws Exception {
    String sql = "SELECT * FROM users";
    PgQueryProtobufParseResult.ByValue result = PgQueryLibInterface.INSTANCE.pg_query_parse_protobuf(sql);

    if (!result.hasError()) {
        // 获取 protobuf 字节数组并解析
        byte[] data = result.getProtobufData();
        ParseResult parseResult = ParseResult.parseFrom(data);
        System.out.println("Version: " + parseResult.getVersion());
    }

    // 必须释放内存
    PgQueryLibInterface.INSTANCE.pg_query_free_protobuf_parse_result(result);
}
```

----------

### pg_query_split_with_scanner - 使用词法分析器分句
使用词法分析器进行分句。

```java
@Test
public void test_split_by_scanner(){
    String input = "select * from t;select * from t;";
    PgQuerySplitResult.ByValue byValue = PgQueryLibInterface
            .INSTANCE
            .pg_query_split_with_scanner(input);
    PointerByReference stmts = byValue.stmts;
    int pointIndex = 0;
    int pointSize = 8; //bytes
    for(int i=0;i<byValue.n_stmts;i++){
        pointIndex = i*pointSize;
        PgQuerySplitStmt.ByReference pgQuerySplitStmt = new PgQuerySplitStmt.ByReference(stmts.getPointer().getPointer(pointIndex));
        pgQuerySplitStmt.read();
        String split = input.substring(pgQuerySplitStmt.stmt_location, pgQuerySplitStmt.stmt_location+ pgQuerySplitStmt.stmt_len);
        assertEquals("select * from t",split);
    }
    PgQueryLibInterface
            .INSTANCE.pg_query_free_split_result(byValue);
}
```

----------

### pg_query_split_with_parser - 使用语法分析器分句
使用语法分析器进行分句。

```java
@Test
public void test_split_by_parser(){
    String input = "select * from t;select * from t;";
    PgQuerySplitResult.ByValue byValue = PgQueryLibInterface
            .INSTANCE
            .pg_query_split_with_parser(input);
    PointerByReference stmts = byValue.stmts;
    int pointIndex = 0;
    int pointSize = 8; //bytes
    for(int i=0;i<byValue.n_stmts;i++){
        pointIndex = i*pointSize;
        PgQuerySplitStmt.ByReference pgQuerySplitStmt = new PgQuerySplitStmt.ByReference(stmts.getPointer().getPointer(pointIndex));
        pgQuerySplitStmt.read();
        String split = input.substring(pgQuerySplitStmt.stmt_location, pgQuerySplitStmt.stmt_location+ pgQuerySplitStmt.stmt_len);
        assertEquals("select * from t",split);
    }
    PgQueryLibInterface
            .INSTANCE.pg_query_free_split_result(byValue);
}
```

----------

### 内存释放方法

| 方法 | 用途 |
|------|------|
| `pg_query_free_parse_result` | 释放 `pg_query_parse` 的结果 |
| `pg_query_free_protobuf_parse_result` | 释放 `pg_query_parse_protobuf` 的结果 |
| `pg_query_free_split_result` | 释放 `pg_query_split_with_*` 的结果 |
