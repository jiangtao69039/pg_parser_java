# pg_parser_java

## 高级 API（推荐使用）

### PgQuery.pgQueryParse(sql) - 解析为 JSON
解析 SQL 语句，返回 JSON 格式的语法树。

```java
import com.github.ttttz.pgParser.PgQueryWrapper;
import com.github.ttttz.pgParser.PgQueryException;

@Test
public void test_parse_json() throws PgQueryException {
    String json = PgQueryWrapper.pgQueryParse("SELECT * FROM users WHERE id = 1");

    System.out.println(json);
    // 输出: {"version":170007,"stmts":[{"stmt":{"SelectStmt":{...}}}]}
}
```

----------

### PgQuery.pgQueryParseProtobuf(sql) - 解析为 Protobuf 对象
解析 SQL 语句，返回强类型的 Protobuf 对象，便于程序化访问语法树。

```java
import com.github.ttttz.pgParser.PgQueryWrapper;
import com.github.ttttz.pgParser.PgQueryException;
import pg_query.PgQuery.ParseResult;
import pg_query.PgQuery.RawStmt;
import pg_query.PgQuery.Node;
import pg_query.PgQuery.SelectStmt;
import pg_query.PgQuery.RangeVar;

@Test
public void test_parse_protobuf() throws PgQueryException {
    ParseResult result = PgQueryWrapper.pgQueryParseProtobuf("SELECT * FROM users WHERE id = 1");

    // 获取语句数量
    System.out.println("Statements count: " + result.getStmtsCount());

    // 获取第一个语句
    RawStmt rawStmt = result.getStmts(0);
    Node stmtNode = rawStmt.getStmt();

    // 检查是否为 SELECT 语句
    if (stmtNode.hasSelectStmt()) {
        SelectStmt selectStmt = stmtNode.getSelectStmt();

        // 获取 FROM 子句中的表名
        Node fromNode = selectStmt.getFromClause(0);
        if (fromNode.hasRangeVar()) {
            RangeVar rangeVar = fromNode.getRangeVar();
            System.out.println("Table name: " + rangeVar.getRelname());
            // 输出: Table name: users
        }
    }
}
```

----------

### PgQuery.pgQuerySplitWithScanner(sql) - 基于词法分割多条 SQL 语句
将多条 SQL 语句分割为列表。该示例基于词法,所以不支持create function begin...end 分句

```java
import com.github.ttttz.pgParser.PgQueryWrapper;
import com.github.ttttz.pgParser.PgQueryException;

import java.util.List;

@Test
public void test_split() throws PgQueryException {
    List<String> statements = PgQueryWrapper.pgQuerySplitWithScanner("SELECT 1; SELECT 2; SELECT 3;");

    System.out.println(statements.size());  // 输出: 3
    System.out.println(statements.get(0));  // 输出: SELECT 1
    System.out.println(statements.get(1));  // 输出: SELECT 2
    System.out.println(statements.get(2));  // 输出: SELECT 3
}
```

### PgQuery.pgQuerySplitWithParser(sql) - 基于语法分割多条 SQL 语句
将多条 SQL 语句分割为列表。该示例基于语法,支持所有pg语法正确的分句

```java
import com.github.ttttz.pgParser.PgQueryWrapper;
import com.github.ttttz.pgParser.PgQueryException;

import java.util.List;

@Test
public void test_split() throws PgQueryException {
    List<String> statements = PgQueryWrapper.pgQuerySplitWithParser("SELECT 1; SELECT 2; SELECT 3;");

    System.out.println(statements.size());  // 输出: 3
    System.out.println(statements.get(0));  // 输出: SELECT 1
    System.out.println(statements.get(1));  // 输出: SELECT 2
    System.out.println(statements.get(2));  // 输出: SELECT 3
}
```

----------

### 错误处理
当 SQL 语法错误时，会抛出 `PgQueryException` 异常。

```java
@Test
public void test_parse_error() {
    try {
        PgQuery.pgQueryParse("SELECT * FROM");  // 不完整的 SQL
    } catch (PgQueryException e) {
        System.out.println("Error: " + e.getMessage());
        // 输出: Error: syntax error at end of input at position 14
    }
}
```

----------
----------
